<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èœœèœ‚ (Space Invaders)</title>
    <style>
        /* å¾©å¤è¡—æ©Ÿé¢¨æ ¼ */
        body {
            font-family: 'Press Start 2P', 'Courier New', monospace; /* æ¨¡æ“¬åƒç´ å­—é«” */
            background: linear-gradient(to bottom right, #000000, #1a1a1a);
            color: #ccff00; /* éœ“è™¹ç¶ è‰² */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }
        /* å¼•å…¥åƒç´ å­—é«”ï¼Œä½†å¦‚æœç’°å¢ƒä¸æ”¯æ´ï¼Œæœƒé€€å› monospace */
        /* ç”±æ–¼ç„¡æ³•è¼‰å…¥å¤–éƒ¨è³‡æºï¼Œæˆ‘å€‘ä¸»è¦ä¾è³´ monospace å­—é«” */
        h1 {
            color: #ff00cc; /* éœ“è™¹ç²‰ */
            text-shadow: 0 0 5px #ff00cc;
        }

        #game-container {
            width: 100%;
            max-width: 650px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.4); /* ç¶ è‰²å…‰æšˆ */
            border-radius: 5px;
            overflow: hidden;
            background-color: #000;
            padding: 10px;
        }

        canvas {
            display: block;
            border: 3px solid #00ff00; /* ç¶ è‰²é‚Šæ¡† */
            background-color: #000000;
            border-radius: 2px;
            touch-action: none; 
            image-rendering: pixelated; /* ç¢ºä¿ç¹ªè£½çš„åƒç´ æ¸…æ™° */
        }

        #game-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            background-color: #0d0d0d;
            border-radius: 3px;
            border: 1px solid #005500;
        }
        
        /* æŒ‰éˆ•é¢¨æ ¼ */
        .game-btn {
            background: #00ff00;
            color: #000000;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 3px;
            box-shadow: 0 3px #009900;
            transition: all 0.05s;
            cursor: pointer;
            border: none;
            user-select: none;
            font-size: 0.8rem;
        }

        .game-btn:active {
            box-shadow: 0 1px #009900;
            transform: translateY(2px);
        }

        #controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px 0;
        }
        
        /* è¨Šæ¯å½ˆçª— (æ²¿ç”¨å‰ä¸€å€‹éŠæˆ²çš„æ¨£å¼ï¼Œä½†æ”¹ç‚ºå¾©å¤é…è‰²) */
        #message-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        #message-content {
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 30px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.7);
            max-width: 90%;
            border: 2px solid #00ff00;
        }

        #message-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-shadow: 0 0 3px #00ff00;
        }
    </style>
</head>
<body>

<div id="game-container">
    <h1>ğŸ‘¾ å°èœœèœ‚å…¥ä¾µ ğŸ‘¾</h1>
    
    <div id="game-stats">
        <span>åˆ†æ•¸: <span id="score">0</span></span>
        <span>ç”Ÿå‘½: <span id="lives">3</span></span>
    </div>

    <!-- éŠæˆ²ç•«å¸ƒ -->
    <canvas id="gameCanvas"></canvas>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div id="controls">
        <button class="game-btn" onclick="movePlayer(-1)">&#9664; å·¦ç§»</button>
        <button class="game-btn" onclick="fireBullet()">å°„æ“Š &#9650;</button>
        <button class="game-btn" onclick="movePlayer(1)">å³ç§» &#9654;</button>
        <button class="game-btn" id="start-btn">é–‹å§‹/æš«åœ</button>
    </div>
</div>

<!-- éŠæˆ²è¨Šæ¯å½ˆçª—/æ¨¡æ…‹æ¡† -->
<div id="message-box">
    <div id="message-content">
        <p id="message-text"></p>
        <button class="game-btn" onclick="hideMessage()">ç¢ºå®š</button>
    </div>
</div>

<script>
    // === éŠæˆ²è¨­å®šèˆ‡è®Šæ•¸ ===
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('score');
    const livesDisplay = document.getElementById('lives');
    const startButton = document.getElementById('start-btn');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const messageContent = document.getElementById('message-content');
    
    let animationId;
    let gameRunning = false;
    let initialTouchX = null;
    let playerControl = 0; // -1: left, 0: stop, 1: right
    let lastFireTime = 0;
    const FIRE_COOLDOWN = 300; // å°„æ“Šå†·å»æ™‚é–“ (æ¯«ç§’)

    // éŠæˆ²ç‹€æ…‹
    let score = 0;
    let lives = 3;
    let invaderSpeed = 0.5; // å…¥ä¾µè€…åŸºç¤é€Ÿåº¦
    const INVADER_DESCENT = 10; // æ¯æ¬¡è½‰å‘ä¸‹é™çš„åƒç´ 

    // ç©å®¶è¨­å®š
    const player = {
        width: 30,
        height: 10,
        x: 0,
        y: 0,
        speed: 5,
        color: '#00ff00' // ç¶ è‰²é£›èˆ¹
    };

    // å­å½ˆè¨­å®š
    const bullet = {
        width: 3,
        height: 10,
        speed: 7,
        color: '#ff00cc' // ç²‰è‰²å­å½ˆ
    };
    let bullets = [];

    // å…¥ä¾µè€…è¨­å®š
    const invader = {
        rows: 5,
        cols: 10,
        width: 25,
        height: 20,
        padding: 10,
        offsetTop: 30,
        offsetLeft: 20,
        colors: ['#00ff00', '#ff0000', '#ffff00', '#00ffff', '#ff00ff'] // å¾©å¤é¡è‰²
    };
    let invaders = [];
    let invaderDirection = 1; // 1: right, -1: left

    // === è¨Šæ¯è™•ç† (å–ä»£ alert/confirm) ===
    function showMessage(text, callback = null) {
        gameRunning = false;
        messageText.textContent = text;
        messageBox.style.display = 'flex';
        messageContent.classList.add('active');
        startButton.textContent = 'é‡æ–°é–‹å§‹';
        
        const okButton = messageContent.querySelector('.game-btn');
        okButton.onclick = () => {
            hideMessage();
            if (callback) callback();
        };
    }

    function hideMessage() {
        messageContent.classList.remove('active');
        messageBox.style.display = 'none';
        startButton.textContent = 'é–‹å§‹/æš«åœ';
    }

    // === åˆå§‹åŒ–èˆ‡é‡ç½® ===

    /** æ ¹æ“šå®¹å™¨å¤§å°èª¿æ•´ç•«å¸ƒå°ºå¯¸ */
    function resizeCanvas() {
        const containerWidth = document.getElementById('game-container').clientWidth - 20; 
        const aspectRatio = 4 / 3; 
        
        canvas.width = containerWidth;
        canvas.height = containerWidth / aspectRatio;

        // ç©å®¶ä½ç½®åˆå§‹åŒ–
        player.x = (canvas.width - player.width) / 2;
        player.y = canvas.height - player.height - 10;
        
        // é‡æ–°èª¿æ•´å…¥ä¾µè€… offsetï¼Œä½¿å…¶å±…ä¸­
        const totalInvadersWidth = invader.cols * invader.width + (invader.cols - 1) * invader.padding;
        invader.offsetLeft = (canvas.width - totalInvadersWidth) / 2;

        if (!gameRunning) {
            draw();
        }
    }

    /** å»ºç«‹å…¥ä¾µè€…é™£åˆ— */
    function createInvaders() {
        invaders = [];
        for (let c = 0; c < invader.cols; c++) {
            for (let r = 0; r < invader.rows; r++) {
                invaders.push({
                    x: c * (invader.width + invader.padding) + invader.offsetLeft,
                    y: r * (invader.height + invader.padding) + invader.offsetTop,
                    status: 1, // 1: æ´»è‘—, 0: æ­»äº¡
                    color: invader.colors[r % invader.colors.length] 
                });
            }
        }
        invaderDirection = 1;
        invaderSpeed = 0.5;
    }
    
    /** é‡ç½®éŠæˆ²ç‹€æ…‹ */
    function resetGame() {
        score = 0;
        lives = 3;
        bullets = [];
        scoreDisplay.textContent = score;
        livesDisplay.textContent = lives;
        createInvaders();
        resizeCanvas(); // å¿…é ˆåœ¨å‰µå»ºå…¥ä¾µè€…å¾Œå‘¼å«ï¼Œä»¥ç¢ºå®šå…¶ä½ç½®
        playerControl = 0;
        gameRunning = false;
        startButton.textContent = 'é–‹å§‹éŠæˆ²';
    }
    
    // === ç¹ªåœ–å‡½æ•¸ ===
    
    /** ç¹ªè£½èƒŒæ™¯ */
    function drawBackground() {
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    /** ç¹ªè£½ç©å®¶é£›èˆ¹ (ä½¿ç”¨å¹¾ä½•å½¢ç‹€æ¨¡æ“¬) */
    function drawPlayer() {
        ctx.fillStyle = player.color;
        // åº•éƒ¨ä¸»é«”
        ctx.fillRect(player.x, player.y, player.width, player.height);
        // é ‚éƒ¨ç ²ç®¡ (ä½æ–¼ä¸­å¿ƒ)
        ctx.fillRect(player.x + player.width / 2 - 2, player.y - 5, 4, 5);
    }

    /** ç¹ªè£½å­å½ˆ */
    function drawBullets() {
        ctx.fillStyle = bullet.color;
        bullets.forEach(b => {
            ctx.fillRect(b.x, b.y, bullet.width, bullet.height);
        });
    }

    /** ç¹ªè£½å…¥ä¾µè€… (ä½¿ç”¨åƒç´ å¡Šæ¨¡æ“¬) */
    function drawInvaders() {
        invaders.forEach(inv => {
            if (inv.status === 1) {
                ctx.fillStyle = inv.color;
                ctx.fillRect(inv.x, inv.y, invader.width, invader.height);
                
                // æ¨¡æ“¬çœ¼ç›æˆ–ç´°ç¯€
                ctx.fillStyle = '#000000';
                ctx.fillRect(inv.x + 5, inv.y + 5, 5, 5);
                ctx.fillRect(inv.x + invader.width - 10, inv.y + 5, 5, 5);
            }
        });
    }
    
    /** ä¸»ç¹ªåœ–å‡½æ•¸ */
    function draw() {
        drawBackground();
        drawInvaders();
        drawPlayer();
        drawBullets();
    }

    // === éŠæˆ²é‚è¼¯ ===

    /** ç©å®¶å°„æ“Š */
    function fireBullet() {
        const now = Date.now();
        if (!gameRunning || now - lastFireTime < FIRE_COOLDOWN) return;

        bullets.push({
            x: player.x + player.width / 2 - bullet.width / 2,
            y: player.y - bullet.height,
        });
        lastFireTime = now;
    }

    /** ç§»å‹•ç©å®¶é£›èˆ¹ */
    function movePlayer(direction) {
        playerControl = direction;
    }

    /** æ›´æ–°ç©å®¶ç‹€æ…‹ */
    function updatePlayer() {
        player.x += playerControl * player.speed;

        // é‚Šç•Œæª¢æŸ¥
        if (player.x < 0) player.x = 0;
        if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
    }

    /** æ›´æ–°å­å½ˆç‹€æ…‹ */
    function updateBullets() {
        bullets.forEach(b => {
            b.y -= bullet.speed;
        });

        // ç§»é™¤è¶…å‡ºè¢å¹•çš„å­å½ˆ
        bullets = bullets.filter(b => b.y + bullet.height > 0);
    }

    /** æ›´æ–°å…¥ä¾µè€…ç‹€æ…‹ */
    function updateInvaders() {
        let shouldDescend = false;
        let lowestY = 0;

        // 1. ç§»å‹•
        invaders.forEach(inv => {
            if (inv.status === 1) {
                inv.x += invaderSpeed * invaderDirection;
                lowestY = Math.max(lowestY, inv.y + invader.height);
            }
        });

        // 2. é‚Šç•Œæª¢æŸ¥èˆ‡è½‰å‘
        const activeInvaders = invaders.filter(inv => inv.status === 1);
        if (activeInvaders.length > 0) {
            const minX = Math.min(...activeInvaders.map(inv => inv.x));
            const maxX = Math.max(...activeInvaders.map(inv => inv.x + invader.width));

            if (maxX > canvas.width - invader.padding || minX < invader.padding) {
                invaderDirection *= -1; // æ”¹è®Šæ–¹å‘
                shouldDescend = true;
            }

            // 3. ä¸‹é™
            if (shouldDescend) {
                invaders.forEach(inv => {
                    if (inv.status === 1) {
                        inv.y += INVADER_DESCENT;
                    }
                });
                // æ¯æ¬¡ä¸‹é™å¾Œï¼Œç¨å¾®å¢åŠ é€Ÿåº¦
                invaderSpeed *= 1.05; 
            }
        }


        // 4. æª¢æŸ¥å¤±æ•—æ¢ä»¶ (å…¥ä¾µè€…åˆ°é”åº•éƒ¨)
        if (lowestY >= player.y) {
             gameOver(false); // å…¥ä¾µè€…ç²å‹
        }
    }
    
    /** ç¢°æ’æª¢æ¸¬ï¼šå­å½ˆ vs. å…¥ä¾µè€… */
    function checkCollisions() {
        for (let i = bullets.length - 1; i >= 0; i--) {
            const b = bullets[i];
            for (let j = invaders.length - 1; j >= 0; j--) {
                const inv = invaders[j];

                if (inv.status === 1) {
                    const hit = b.x < inv.x + invader.width &&
                                b.x + bullet.width > inv.x &&
                                b.y < inv.y + invader.height &&
                                b.y + bullet.height > inv.y;

                    if (hit) {
                        // æ“Šä¸­ï¼
                        inv.status = 0; // éŠ·æ¯€å…¥ä¾µè€…
                        bullets.splice(i, 1); // éŠ·æ¯€å­å½ˆ
                        score += 10;
                        scoreDisplay.textContent = score;
                        
                        // æª¢æŸ¥æ˜¯å¦å‹åˆ©
                        if (invaders.every(inv => inv.status === 0)) {
                            gameOver(true); 
                            return; 
                        }
                        // ç”±æ–¼å­å½ˆè¢«ç§»é™¤ï¼Œè·³å‡ºå…§å±¤å¾ªç’°
                        break; 
                    }
                }
            }
        }
    }

    /** éŠæˆ²çµæŸ */
    function gameOver(isWin) {
        cancelAnimationFrame(animationId);
        gameRunning = false;
        if (isWin) {
            showMessage(`æ­å–œ! æ‚¨æˆåŠŸæ“Šé€€äº†æ‰€æœ‰å…¥ä¾µè€…! æœ€çµ‚åˆ†æ•¸: ${score}`, resetGame);
        } else {
            showMessage(`éŠæˆ²å¤±æ•—! å¤–æ˜ŸäººæŠµé”åœ°é¢! æ‚¨çš„åˆ†æ•¸æ˜¯: ${score}`, resetGame);
        }
    }

    /** éŠæˆ²ä¸»å¾ªç’° */
    function gameLoop() {
        if (!gameRunning) return;

        updatePlayer();
        updateBullets();
        updateInvaders();
        checkCollisions();

        draw();
        
        animationId = requestAnimationFrame(gameLoop);
    }

    /** é–‹å§‹/æš«åœéŠæˆ² */
    function toggleGame() {
        if (lives <= 0) {
            // å¦‚æœç”Ÿå‘½è€—ç›¡ï¼Œå…ˆé‡ç½®éŠæˆ²
            resetGame(); 
        }

        if (gameRunning) {
            cancelAnimationFrame(animationId);
            gameRunning = false;
            startButton.textContent = 'ç¹¼çºŒéŠæˆ²';
        } else {
            gameRunning = true;
            startButton.textContent = 'æš«åœéŠæˆ²';
            gameLoop();
        }
    }

    // === äº‹ä»¶ç›£è½å™¨ ===
    
    // éµç›¤æ§åˆ¶
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === 'd') {
            movePlayer(1);
        } else if (e.key === 'ArrowLeft' || e.key === 'a') {
            movePlayer(-1);
        } else if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            fireBullet();
        } else if (e.key === 'p' || e.key === 'P') {
            toggleGame();
        }
    });

    document.addEventListener('keyup', (e) => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft' || e.key === 'd' || e.key === 'a') {
            movePlayer(0); 
        }
    });
    
    // è§¸æ§æ§åˆ¶
    let touchStartX = null;
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        touchStartX = e.touches[0].clientX;
        // é¦–æ¬¡è§¸ç¢°è§¸ç™¼å°„æ“Š
        fireBullet(); 
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (touchStartX === null) return;
        
        const currentTouchX = e.touches[0].clientX;
        const diff = currentTouchX - touchStartX;

        // æ ¹æ“šç§»å‹•è·é›¢èª¿æ•´ç©å®¶ä½ç½®
        player.x += diff * 1.5; 

        // é‚Šç•Œæª¢æŸ¥
        if (player.x < 0) player.x = 0;
        if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

        touchStartX = currentTouchX;

        if (!gameRunning) {
            draw(); 
        }
    }, { passive: false });

    canvas.addEventListener('touchend', (e) => {
        touchStartX = null;
        playerControl = 0; // è§¸æ§çµæŸå¾Œåœæ­¢ç§»å‹•
    });
    
    canvas.addEventListener('click', fireBullet); // é»æ“Šç•«å¸ƒå°„æ“Š (å‚™ç”¨)

    // é–‹å§‹æŒ‰éˆ•
    startButton.addEventListener('click', toggleGame);

    // è¦–çª—å¤§å°æ”¹è®Šæ™‚ï¼Œé‡æ–°èª¿æ•´ç•«å¸ƒ
    window.addEventListener('resize', resizeCanvas);
    
    // éŠæˆ²åˆå§‹åŒ–
    window.onload = function() {
        resetGame(); // åˆå§‹åŒ–æ‰€æœ‰ç‰©ä»¶å’Œé™£åˆ—
        // resizeCanvas() åœ¨ resetGame() è£¡å·²ç¶“å‘¼å«
        draw(); 
        
        showMessage("å°èœœèœ‚å…¥ä¾µï¼\nä½¿ç”¨å·¦å³ç®­é ­æˆ–æ»‘å‹•è¢å¹•ç§»å‹•ã€‚\næŒ‰ç©ºç™½éµæˆ–é»æ“Šå°„æ“ŠæŒ‰éˆ•ä¾†é˜²ç¦¦ï¼", null);
    };

</script>
</body>
</html>